# 功能更新：思维导图中创建子节点时同步创建子任务

## 概述
在思维导图视图（TodoTree.vue）中创建子节点时，现在会自动同步创建对应的子任务，确保思维导图与任务列表保持一致。

## 实现细节

### 1. 数据结构增强
在 `mindMapData` 计算属性中，添加了 `id` 字段到节点数据中：
```javascript
data: {
  text: todo.title || '未命名任务',
  status: todo.status || 'todo',
  id: todo.id  // 新增：便于后续 ID 关联
}
```

这样每个思维导图节点都能够关联到对应的任务 ID。

### 2. 事件监听机制
在 MindMap 实例初始化后，添加了三个关键事件监听：

#### a. `node_content_change` - 节点内容修改
- **触发时机**：节点文本被修改时
- **处理逻辑**：更新对应任务的标题
- **数据库操作**：调用 `updateTodo()`

#### b. `node_insert` - 新节点插入
- **触发时机**：在思维导图中插入新节点时
- **处理逻辑**：
  1. 获取父节点的 ID
  2. 验证父任务是否存在
  3. 检查是否已存在相同的子任务
  4. 创建新的子任务
  5. 更新节点数据中的 ID
  6. 更新追踪的任务 ID 集合

#### c. `node_click` - 节点点击
- **触发时机**：用户点击节点时
- **处理逻辑**：作为备选机制捕获已编辑但未 ID 关联的节点
- **目的**：确保编辑完成的新节点也能被同步

### 3. 任务 ID 追踪
维护 `existingTodoIds` Set 来追踪所有现有任务的 ID，用于：
- 判断是否是新创建的节点
- 验证父任务是否存在
- 避免重复创建任务

## 使用流程

### 创建子任务的完整流程：
1. 用户在思维导图中选中父节点
2. 用户插入新子节点（通过快捷键或菜单）
3. 用户输入节点文本
4. `node_insert` 事件触发
5. 系统自动创建对应的子任务到数据库
6. 节点数据更新为新创建任务的 ID
7. 思维导图和任务列表自动同步

### 编辑节点文本的流程：
1. 用户编辑节点文本
2. `node_content_change` 事件触发
3. 系统更新对应任务的标题
4. 所有展示该任务的地方自动更新

## 关键特性

✅ **实时同步**：思维导图的变更立即同步到数据库
✅ **双向一致**：任务和思维导图节点保持一致
✅ **智能去重**：避免创建重复的任务
✅ **错误处理**：所有操作都有完整的异常处理
✅ **调试日志**：完整的控制台日志便于问题排查

## 相关文件修改

- **frontend/src/pages/work/TodoTree.vue**
  - 导入 `useTodoStore()`
  - 添加 `existingTodoIds` 追踪集合
  - 增强 `mindMapData` 计算属性
  - 添加事件监听器（`node_content_change`, `node_insert`, `node_click`）

## 技术细节

### 节点 ID 关联
```javascript
// 节点数据中包含任务 ID
nodeData = { text: '任务标题', status: 'todo', id: 123 }

// 使用 node.setData() 更新节点数据
node.setData({ ...nodeData, id: result.data.id })
```

### 异步操作处理
所有数据库操作都是异步的，使用 `async/await` 处理，确保操作完成后才更新前端状态。

### 防重检查
```javascript
// 检查是否已存在相同的子任务
const existingTodo = props.todos.find(
  t => t.title === text && t.parent_id === parentId
)
if (!existingTodo) {
  // 创建新任务
}
```

## 注意事项

1. **性能考虑**：频繁的节点创建可能产生多个数据库请求，建议添加防抖机制
2. **并发处理**：多用户同时编辑时可能产生竞态条件，建议在服务器端添加额外的检查
3. **用户反馈**：建议在创建失败时提示用户，目前仅记录日志

## 未来改进方向

- [ ] 添加用户友好的错误提示界面
- [ ] 实现批量操作的防抖
- [ ] 添加撤销/重做功能
- [ ] 支持在思维导图中直接删除任务
- [ ] 支持拖拽改变任务层级关系
