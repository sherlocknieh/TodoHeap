# 需求说明

## 1. 项目概述

### 1.1 项目背景

TodoHeap 是一个基于堆数据结构的智能任务管理应用，通过 AI 技术自动分解复杂任务，帮助用户高效管理待办事项。系统采用优先级算法自动排序任务，将最优先的任务置于堆顶，减少用户决策成本。

### 1.2 项目目标

- 提供简洁高效的任务管理功能
- 利用 AI 技术自动分解复杂任务为可执行的子任务
- 基于堆结构智能排序，自动展示最优先任务
- 支持多视图展示（列表、树形、堆结构）
- 实现云端数据同步，支持多端访问

### 1.3 目标用户

- 个人用户：需要管理日常任务和项目的个人
- 学生：需要管理学习任务和作业的学生
- 开发者：需要管理开发任务和项目的技术人员

### 1.4 术语定义

| 术语 | 定义 |
|------|------|
| 任务（Todo） | 用户创建的待办事项，包含标题、描述、优先级等属性 |
| 子任务（Subtask） | 通过 AI 分解或手动创建的任务子项 |
| 堆（Heap） | 一种特殊的树形数据结构，用于优先级排序 |
| 优先级分数 | 综合多个维度计算的任务优先级数值 |
| AI 分解 | 使用人工智能技术将复杂任务分解为子任务 |

## 2. 功能需求

### 2.1 用户认证模块（P0）

#### 2.1.1 用户注册

**需求描述：**
用户可通过邮箱和密码注册账户。

**功能要求：**
- 邮箱格式验证
- 密码长度至少 6 个字符
- 密码确认验证
- 注册成功后自动登录
- 错误提示信息清晰

**输入：**
- 邮箱地址（必填）
- 密码（必填，≥6 字符）
- 确认密码（必填）

**输出：**
- 注册成功：跳转到应用主页面
- 注册失败：显示错误信息

#### 2.1.2 用户登录

**需求描述：**
已注册用户可通过邮箱和密码登录系统。

**功能要求：**
- 邮箱和密码验证
- 登录状态持久化（JWT Token）
- 登录成功后跳转到应用主页面
- 已登录用户访问登录页自动跳转

**输入：**
- 邮箱地址
- 密码

**输出：**
- 登录成功：获取 Token，跳转到应用页面
- 登录失败：显示错误信息

#### 2.1.3 用户登出

**需求描述：**
用户可主动退出登录。

**功能要求：**
- 清除本地认证信息
- 跳转到登录页面
- 清除用户数据缓存

### 2.2 任务管理模块（P0）

#### 2.2.1 创建任务

**需求描述：**
用户可创建新的任务项。

**功能要求：**
- 任务标题必填
- 支持设置优先级（P1/P2/P3）
- 支持设置截止日期
- 支持设置任务描述
- 创建成功后立即显示在列表中

**输入：**
- 任务标题（必填）
- 优先级（可选，默认 P3）
- 截止日期（可选）
- 任务描述（可选）

**输出：**
- 创建成功：返回任务对象，更新列表
- 创建失败：显示错误信息

#### 2.2.2 编辑任务

**需求描述：**
用户可修改已创建的任务信息。

**功能要求：**
- 支持修改标题、描述、优先级、截止日期
- 支持内联编辑（点击标题直接编辑）
- 修改后自动保存
- 支持取消编辑

**输入：**
- 任务 ID
- 修改后的字段值

**输出：**
- 更新成功：刷新任务显示
- 更新失败：显示错误信息

#### 2.2.3 删除任务

**需求描述：**
用户可删除不需要的任务。

**功能要求：**
- 支持软删除（标记为已删除）
- 删除父任务时级联删除子任务
- 删除操作需确认（可选）
- 删除后从列表中移除

**输入：**
- 任务 ID

**输出：**
- 删除成功：从列表中移除
- 删除失败：显示错误信息

#### 2.2.4 完成任务

**需求描述：**
用户可标记任务为已完成状态。

**功能要求：**
- 点击复选框切换完成状态
- 已完成任务显示为已完成样式
- 支持取消完成状态
- 完成状态变更后重新计算优先级

**输入：**
- 任务 ID

**输出：**
- 状态更新成功：刷新显示
- 状态更新失败：显示错误信息

#### 2.2.5 创建子任务

**需求描述：**
用户可为任务创建子任务。

**功能要求：**
- 支持手动创建子任务
- 子任务继承父任务的优先级和截止日期（可选）
- 子任务显示在父任务下方，有层级缩进
- 支持多级嵌套（理论上无限制）

**输入：**
- 父任务 ID
- 子任务标题
- 子任务其他属性（可选）

**输出：**
- 创建成功：显示在父任务下
- 创建失败：显示错误信息

### 2.3 任务视图模块（P0）

#### 2.3.1 列表视图

**需求描述：**
以扁平列表形式展示所有任务，支持层级缩进。

**功能要求：**
- 显示任务标题、状态、优先级
- 子任务通过缩进显示层级关系
- 支持展开/折叠子任务（可选）
- 显示任务统计信息（待办、今天、即将到期、已完成）

**显示内容：**
- 任务标题
- 状态标签（待办/进行中/完成）
- 优先级标签
- 截止日期（如有）
- 操作按钮（编辑、删除、添加子任务）

#### 2.3.2 树视图

**需求描述：**
以思维导图形式可视化任务结构。

**功能要求：**
- 使用思维导图库渲染任务树
- 支持节点拖拽创建子任务
- 支持点击节点编辑标题
- 支持缩放和平移视图
- 自动保存视图状态（位置、缩放级别）

**交互功能：**
- 拖拽节点到其他节点创建子任务
- 双击节点编辑标题
- 鼠标滚轮缩放
- 拖拽画布平移

#### 2.3.3 堆视图

**需求描述：**
以堆数据结构展示任务优先级排序。

**功能要求：**
- 可视化堆结构图（SVG 绘制）
- 显示优先级分数
- 列表形式展示排序结果
- 最高优先级任务在顶部
- 支持选择任务

**显示内容：**
- 堆结构可视化图
- 任务列表（按优先级排序）
- 优先级分数
- 任务排名

### 2.4 AI 任务分解模块（P0）

#### 2.4.1 AI 分解任务

**需求描述：**
用户可对选中的任务发起 AI 自动分解，生成子任务列表。

**功能要求：**
- 在树视图中选择要分解的任务节点
- 输入分解指令（如"分解为 5 个步骤"）
- 调用 AI 服务生成子任务
- 自动创建子任务并添加到任务树
- 显示分解进度和结果

**输入：**
- 任务 ID
- 分解指令（文本）

**输出：**
- 分解成功：返回子任务列表，自动创建
- 分解失败：显示错误信息或提示人工审阅

**AI 返回格式：**
```json
{
  "children": [
    {
      "title": "子任务标题",
      "status": "todo",
      "priority": 1
    }
  ]
}
```

#### 2.4.2 分解结果处理

**需求描述：**
处理 AI 返回的分解结果，创建子任务。

**功能要求：**
- 验证 AI 返回数据格式
- 批量创建子任务
- 设置正确的父子关系（parent_id）
- 处理创建失败的情况
- 显示创建结果统计

### 2.5 优先级计算模块（P0）

#### 2.5.1 优先级算法

**需求描述：**
基于多维度综合计算任务优先级分数。

**计算维度：**
1. **基础优先级**：用户手动设置的优先级等级（权重 100）
2. **紧急度**：基于截止日期的紧急程度（权重 30）
3. **完成度**：子任务完成比例（权重 20）
4. **复杂度**：子任务数量（权重 10）
5. **状态**：任务当前状态（权重 5）

**计算公式：**
```
finalScore = baseScore × 100 + urgencyScore × 30 + progressScore × 20 + complexityScore × 10 + statusScore × 5
```

#### 2.5.2 堆排序

**需求描述：**
使用大顶堆数据结构对任务进行排序。

**功能要求：**
- 构建堆结构
- 最高优先级任务在堆顶
- 支持动态更新和重新排序
- 可视化堆结构

### 2.6 搜索与筛选模块（P1）

#### 2.6.1 任务搜索

**需求描述：**
用户可通过关键词搜索任务和子任务。

**功能要求：**
- 实时搜索（输入即搜索）
- 搜索任务标题和描述
- 高亮显示匹配结果
- 支持清空搜索

**输入：**
- 搜索关键词

**输出：**
- 匹配的任务列表

#### 2.6.2 任务筛选

**需求描述：**
用户可按条件筛选任务。

**筛选条件：**
- 状态筛选：全部/待办/进行中/已完成
- 优先级筛选：全部/P1/P2/P3
- 日期筛选：今天/即将到期/已过期（可选）

**功能要求：**
- 支持多条件组合筛选
- 筛选结果实时更新
- 显示筛选结果数量

### 2.7 设置模块（P1）

#### 2.7.1 账户设置

**需求描述：**
用户可查看和修改账户信息。

**功能要求：**
- 显示邮箱地址
- 显示账户创建时间
- 修改密码功能
- 退出登录功能
- 删除账户功能（需确认）

#### 2.7.2 主题设置

**需求描述：**
用户可选择界面主题。

**功能要求：**
- 支持浅色/深色主题切换
- 主题设置持久化保存
- 切换后立即生效

#### 2.7.3 通知设置

**需求描述：**
用户可配置通知偏好。

**功能要求：**
- 邮件通知开关
- 推送通知开关
- 任务提醒开关
- 设置持久化保存

## 3. 非功能需求

### 3.1 性能需求

- 页面加载时间：首屏加载时间 < 2 秒
- 任务列表渲染：1000 条任务渲染时间 < 1 秒
- API 响应时间：平均响应时间 < 500ms
- 搜索响应时间：实时搜索延迟 < 300ms

### 3.2 可用性需求

- 系统可用性：99% 以上
- 数据同步：实时同步，延迟 < 1 秒
- 错误恢复：网络错误自动重试，最多 3 次
- 离线支持：支持离线查看（P2 功能）

### 3.3 安全需求

- 用户认证：JWT Token 认证，Token 有效期管理
- 数据隔离：行级安全策略（RLS），用户只能访问自己的数据
- 输入验证：前端和后端双重验证
- 密码安全：密码加密存储，不存储明文
- SQL 注入防护：使用参数化查询

### 3.4 兼容性需求

- 浏览器支持：Chrome、Firefox、Safari、Edge 最新版本
- 响应式设计：支持桌面端和移动端
- 屏幕分辨率：最小支持 320px 宽度

### 3.5 可维护性需求

- 代码规范：遵循 Vue 3 和 JavaScript 编码规范
- 代码注释：关键函数和复杂逻辑需添加注释
- 文档完整：API 文档、用户手册、开发文档齐全
- 版本控制：使用 Git 进行版本管理

## 4. 系统约束

### 4.1 技术约束

- 前端框架：Vue 3（Composition API）
- 构建工具：Vite
- 后端平台：Supabase（PostgreSQL + Edge Functions）
- 认证服务：Supabase Auth
- AI 服务：OpenAI API（可配置）

### 4.2 开发约束

- 前端代码目录：`frontend/src`
- 后端函数目录：`supabase/functions`
- 数据库迁移目录：`supabase/migrations`
- 文档目录：`docs/`
- 依赖管理：Node.js（前端）、requirements.txt（文档）

### 4.3 部署约束

- 前端部署：GitHub Pages
- 后端部署：Supabase Cloud
- 文档部署：GitHub Pages（MkDocs）

### 4.4 数据约束

- 任务标题：最大长度 500 字符
- 任务描述：最大长度 5000 字符
- 子任务层级：理论上无限制，建议不超过 10 层
- 单用户任务数：无硬性限制

## 5. 数据模型

### 5.1 核心表结构

**todos 表：**

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGSERIAL | PRIMARY KEY | 任务 ID |
| user_id | UUID | NOT NULL, FK | 用户 ID（关联 auth.users） |
| parent_id | BIGINT | FK → todos.id | 父任务 ID（NULL 表示根任务） |
| title | TEXT | NOT NULL | 任务标题 |
| description | TEXT | NULL | 任务描述 |
| deadline | TIMESTAMPTZ | NULL | 截止时间 |
| status | TEXT | DEFAULT 'todo' | 状态：todo/doing/done |
| priority | INTEGER | DEFAULT 0 | 优先级：0=无,1=低,2=中,3=高 |
| sort_order | INTEGER | DEFAULT 0 | 自定义排序 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 更新时间 |
| deleted_at | TIMESTAMPTZ | NULL | 软删除标记 |

### 5.2 索引设计

- `idx_todos_user_active`：用户活跃任务查询（user_id, status）
- `idx_todos_user_parent`：父任务查询（user_id, parent_id）
- `idx_todos_priority`：优先级查询（user_id, priority, deadline）

### 5.3 视图设计

- `active_todos`：活跃任务视图
- `leaf_todos`：叶子任务视图
- `root_todos`：根任务视图
- `v_todos_tree`：任务树视图（递归 CTE）
- `v_todos_with_progress`：带进度的任务视图

## 6. 接口规范

### 6.1 认证接口

**注册：**
- 方法：POST
- 端点：`/auth/v1/signup`
- 请求体：`{ email: string, password: string }`
- 响应：`{ user: User, session: Session }`

**登录：**
- 方法：POST
- 端点：`/auth/v1/token`
- 请求体：`{ email: string, password: string }`
- 响应：`{ access_token: string, refresh_token: string }`

### 6.2 任务接口

**获取任务列表：**
- 方法：GET
- 端点：`/rest/v1/todos`
- 查询参数：`select`, `order`, `eq.user_id`
- 响应：`Todo[]`

**创建任务：**
- 方法：POST
- 端点：`/rest/v1/todos`
- 请求体：`{ title: string, priority?: number, deadline?: string, ... }`
- 响应：`Todo`

**更新任务：**
- 方法：PATCH
- 端点：`/rest/v1/todos?id=eq.{id}`
- 请求体：`{ title?: string, status?: string, ... }`
- 响应：`Todo`

**删除任务：**
- 方法：DELETE
- 端点：`/rest/v1/todos?id=eq.{id}`
- 响应：`204 No Content`

### 6.3 AI 分解接口

**任务分解：**
- 方法：POST
- 端点：`/functions/v1/breakdown_task`
- 请求体：
```json
{
  "todosTree": TreeNode | TreeNode[],
  "selectedNodeId": number,
  "query": string
}
```
- 响应：
```json
{
  "children": [
    {
      "title": "string",
      "status": "todo",
      "priority": 1
    }
  ]
}
```

## 7. 验收标准

### 7.1 功能验收

**用户认证：**
- ✅ 用户可成功注册账户
- ✅ 用户可成功登录
- ✅ 未登录用户访问受保护页面自动跳转登录页
- ✅ 已登录用户访问登录页自动跳转应用页

**任务管理：**
- ✅ 用户可创建、编辑、删除任务
- ✅ 用户可标记任务为完成状态
- ✅ 用户可创建子任务
- ✅ 删除父任务时子任务级联删除

**视图展示：**
- ✅ 列表视图正确显示任务层级
- ✅ 树视图正确渲染任务树结构
- ✅ 堆视图正确显示优先级排序

**AI 分解：**
- ✅ AI 分解成功生成子任务
- ✅ 子任务正确关联父任务
- ✅ 分解失败时显示错误信息

### 7.2 性能验收

- ✅ 页面加载时间 < 2 秒
- ✅ 任务列表渲染流畅（1000 条任务）
- ✅ 搜索响应及时（< 300ms）

### 7.3 安全验收

- ✅ 用户数据隔离（RLS 策略生效）
- ✅ 未授权用户无法访问他人数据
- ✅ 输入验证有效（前后端双重验证）

## 8. 未来扩展（P2）

### 8.1 功能扩展

- 团队协作：任务共享和协作
- 标签系统：任务标签分类
- 附件支持：任务附件上传和管理
- 日历视图：基于日期的任务展示
- 甘特图：任务依赖关系可视化

### 8.2 技术扩展

- PWA 支持：离线访问和安装
- 移动端应用：原生移动应用
- 国际化：多语言支持
- 主题定制：用户自定义主题色

---

**文档版本：** 1.0  
**最后更新：** 2025年12月
